<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Addictive Shooter Game + Inventory + Shop (Magnet)</title>
<style>
  body { margin:0; overflow:hidden; background:#111; font-family:sans-serif; }
  canvas { display:block; margin:auto; background:#222; }

  #hud {
    position:absolute; left:10px; top:10px; right:10px; pointer-events:none;
  }

  #score {
    pointer-events:auto;
    position:absolute; top:10px; left:10px;
    color:white; font-size:30px; font-weight:bold;
    transition: transform 0.2s ease, color 0.2s ease, text-shadow 0.2s ease;
  }
  #score.pop { transform: scale(1.6); color: gold; text-shadow: 0 0 20px yellow; }

  /* MOVED: money now under score */
  #money {
    position:absolute;
    left:10px;
    top:55px; /* under score */
    color:#9f9;
    font-size:22px;
    font-weight:bold;
    pointer-events:auto;
  }

  #pausedText {
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%, -50%);
    text-align:center;
    color:white;
    display:none;
    pointer-events:none;
  }
  #pausedText h1 { font-size:80px; margin:0; }
  #pausedText p { font-size:24px; margin:10px 0 0 0; }

  #topButtons {
    position:absolute; right:10px; top:10px; display:flex; gap:10px; pointer-events:auto;
  }

  .btn {
    color: white;
    background: #333;
    padding: 10px 14px;
    text-decoration: none;
    border-radius: 8px;
    font-family: sans-serif;
    font-size: 16px;
    cursor:pointer;
    user-select:none;
    border: 1px solid #444;
  }
  .btn:hover { background:#555; }

  #goBack { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); color: white; background: #333; padding: 10px 20px; text-decoration: none; border-radius: 8px; font-family: sans-serif; font-size: 18px; pointer-events:auto; }
  #goBack:hover { background: #555; }

  /* Inventory popup & Shop popup */
  #inventoryOverlay, #shopOverlay {
    position: absolute;
    left:0; top:0; right:0; bottom:0;
    background: rgba(0,0,0,0.6);
    display:none;
    align-items:center;
    justify-content:center;
    pointer-events:auto;
    z-index:50;
  }
  #inventoryBox, #shopBox {
    width: 500px;
    background:#1a1a1a;
    border-radius:12px;
    padding:18px;
    color:white;
    box-shadow: 0 6px 30px rgba(0,0,0,0.7);
    border: 1px solid #333;
    font-family: sans-serif;
  }
  #inventoryBox h2, #shopBox h2 { margin:0 0 14px 0; text-align:center; }
  .inv-row, .shop-row { display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid rgba(255,255,255,0.04); }
  .inv-left, .shop-left { display:flex; gap:12px; align-items:center; }
  .inv-emoji { font-size:28px; width:36px; text-align:center; }
  .inv-name { font-size:18px; }
  .inv-count { opacity:0.9; font-weight:bold; }
  .inv-use { background:#2b7; color:#002; padding:6px 10px; border-radius:8px; cursor:pointer; border:none; font-weight:bold; }
  .inv-use:disabled { opacity:0.35; cursor:not-allowed; }

  .shop-btn { background:#2b7; color:#002; padding:6px 10px; border-radius:8px; cursor:pointer; border:none; font-weight:bold; margin-left:6px; }
  .shop-btn.sell { background:#d55; color:#200; }

  #closeInv, #closeShop, .openOther { margin-top:12px; display:block; width:100%; padding:8px; background:#444; border-radius:8px; color:white; border:none; cursor:pointer; font-size:16px; }

  /* floating pickup text */
  .pickupToast {
    position:absolute; color:#ffd; font-weight:bold; pointer-events:none;
    text-shadow: 0 0 10px rgba(0,0,0,0.6);
  }
</style>
</head>
<body>
  <div id="hud">
    <div id="score">Score: 0</div>
    <div id="money">Money: $0</div>
    <div id="topButtons">
      <button id="openInvBtn" class="btn">Open Inventory</button>
      <button id="pauseBtn" class="btn">Pause (P)</button>
      <button id="openShopBtn" class="btn">Open Shop (S)</button>
    </div>
  </div>

  <div id="pausedText">
    <h1>PAUSED</h1>
    <p>Press R to resume</p>
  </div>

  <!-- Inventory Popup -->
  <div id="inventoryOverlay" aria-hidden="true">
    <div id="inventoryBox">
      <h2>INVENTORY</h2>

      <div class="inv-row">
        <div class="inv-left">
          <div class="inv-emoji">üí£</div>
          <div>
            <div class="inv-name">Bomb</div>
            <div class="inv-count" id="invBombText">0√ó</div>
          </div>
        </div>
        <div>
          <button id="useBomb" class="inv-use">Use</button>
        </div>
      </div>

      <div class="inv-row">
        <div class="inv-left">
          <div class="inv-emoji">üõ°Ô∏è</div>
          <div>
            <div class="inv-name">Shield</div>
            <div class="inv-count" id="invShieldText">0√ó</div>
          </div>
        </div>
        <div>
          <button id="useShield" class="inv-use">Use</button>
        </div>
      </div>

      <div class="inv-row">
        <div class="inv-left">
          <div class="inv-emoji">üåÄ</div>
          <div>
            <div class="inv-name">Black Hole</div>
            <div class="inv-count" id="invBHText">0√ó</div>
          </div>
        </div>
        <div>
          <button id="useBH" class="inv-use">Use</button>
        </div>
      </div>

      <!-- Rapid Fire inventory row (shop-only ability) -->
      <div class="inv-row">
        <div class="inv-left">
          <div class="inv-emoji">‚ö°</div>
          <div>
            <div class="inv-name">Rapid Fire</div>
            <div class="inv-count" id="invRapidText">0√ó</div>
          </div>
        </div>
        <div>
          <button id="useRapid" class="inv-use">Use</button>
        </div>
      </div>

      <!-- Magnet inventory row (shop-only ability) -->
      <div class="inv-row">
        <div class="inv-left">
          <div class="inv-emoji">üß≤</div>
          <div>
            <div class="inv-name">Magnet (12s)</div>
            <div class="inv-count" id="invMagnetText">0√ó</div>
          </div>
        </div>
        <div>
          <button id="useMagnet" class="inv-use">Use</button>
        </div>
      </div>

      <button id="openShopFromInv" class="openOther">Open Shop</button>
      <button id="closeInv">Close Inventory (C)</button>
    </div>
  </div>

  <!-- Shop Popup -->
  <div id="shopOverlay" aria-hidden="true">
    <div id="shopBox">
      <h2>SHOP ‚Äî Price: $50 each</h2>

      <div class="shop-row">
        <div class="shop-left">
          <div class="inv-emoji">üí£</div>
          <div>
            <div class="inv-name">Bomb</div>
            <div class="inv-count" id="shopBombCount">0√ó</div>
          </div>
        </div>
        <div>
          <button id="buyBomb" class="shop-btn">Buy $50</button>
          <button id="sellBomb" class="shop-btn sell">Sell $50</button>
        </div>
      </div>

      <div class="shop-row">
        <div class="shop-left">
          <div class="inv-emoji">üõ°Ô∏è</div>
          <div>
            <div class="inv-name">Shield</div>
            <div class="inv-count" id="shopShieldCount">0√ó</div>
          </div>
        </div>
        <div>
          <button id="buyShield" class="shop-btn">Buy $50</button>
          <button id="sellShield" class="shop-btn sell">Sell $50</button>
        </div>
      </div>

      <div class="shop-row">
        <div class="shop-left">
          <div class="inv-emoji">üåÄ</div>
          <div>
            <div class="inv-name">Black Hole</div>
            <div class="inv-count" id="shopBHCount">0√ó</div>
          </div>
        </div>
        <div>
          <button id="buyBH" class="shop-btn">Buy $50</button>
          <button id="sellBH" class="shop-btn sell">Sell $50</button>
        </div>
      </div>

      <!-- Rapid Fire shop-only row -->
      <div class="shop-row">
        <div class="shop-left">
          <div class="inv-emoji">‚ö°</div>
          <div>
            <div class="inv-name">Rapid Fire (10s)</div>
            <div class="inv-count" id="shopRapidCount">0√ó</div>
          </div>
        </div>
        <div>
          <button id="buyRapid" class="shop-btn">Buy $50</button>
          <button id="sellRapid" class="shop-btn sell">Sell $50</button>
        </div>
      </div>

      <!-- Magnet shop-only row -->
      <div class="shop-row">
        <div class="shop-left">
          <div class="inv-emoji">üß≤</div>
          <div>
            <div class="inv-name">Magnet (12s)</div>
            <div class="inv-count" id="shopMagnetCount">0√ó</div>
          </div>
        </div>
        <div>
          <button id="buyMagnet" class="shop-btn">Buy $50</button>
          <button id="sellMagnet" class="shop-btn sell">Sell $50</button>
        </div>
      </div>

      <button id="openInvFromShop" class="openOther">Open Inventory</button>
      <button id="closeShop">Close Shop (C)</button>
    </div>
  </div>

  <canvas id="gameCanvas" width="800" height="600"></canvas>
  <a id="goBack" href="index.html">Go Back</a>

<script>
/* ------------------------
   CORE GAME (modified)
   ------------------------ */
const canvas = document.getElementById("gameCanvas");
const ctx = canvas.getContext("2d");
const scoreDisplay = document.getElementById("score");
const moneyDisplay = document.getElementById("money");
const pausedText = document.getElementById("pausedText");

function dist(a,b){ return Math.hypot(a.x-b.x, a.y-b.y); }

let mouse = {x: canvas.width/2, y: canvas.height/2};
canvas.addEventListener("mousemove", e=>{
  const rect = canvas.getBoundingClientRect();
  mouse.x = e.clientX - rect.left;
  mouse.y = e.clientY - rect.top;
});

/* Player */
class Player {
  constructor(){
    this.x = canvas.width/2;
    this.y = canvas.height/2;
    this.radius = 15;
    this.color = "cyan";
    this.speed = 5;
    this.shielded = false;
  }
  move(){
    const dx = mouse.x - this.x;
    const dy = mouse.y - this.y;
    const distance = Math.hypot(dx,dy);
    if(distance>1){
      const speed = Math.min(distance*0.1,this.speed);
      this.x += dx/distance*speed;
      this.y += dy/distance*speed;
    }
    this.x = Math.max(this.radius, Math.min(canvas.width-this.radius, this.x));
    this.y = Math.max(this.radius, Math.min(canvas.height-this.radius, this.y));
  }
  draw(){
    ctx.beginPath();
    ctx.arc(this.x, this.y, this.radius,0,Math.PI*2);
    ctx.fillStyle = this.color;
    ctx.fill();
    if(this.shielded){
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.radius+8, 0, Math.PI*2);
      ctx.strokeStyle = "rgba(0,200,255,0.7)";
      ctx.lineWidth = 4;
      ctx.stroke();
    }
  }
}

/* Bullet */
class Bullet {
  constructor(x,y,targetX,targetY){
    this.x=x; this.y=y;
    const angle = Math.atan2(targetY - y, targetX - x);
    this.dx=Math.cos(angle)*10;
    this.dy=Math.sin(angle)*10;
    this.radius=5; this.color="yellow";
  }
  update(){ this.x+=this.dx; this.y+=this.dy; }
  draw(){
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fillStyle=this.color; ctx.fill();
  }
}

/* Enemy */
class Enemy {
  constructor(type="red"){
    this.type = type;
    this.radius = 20 + Math.random()*10;
    const edge = Math.floor(Math.random()*4);
    if(edge===0){ this.x=-this.radius; this.y=Math.random()*canvas.height; }
    if(edge===1){ this.x=canvas.width+this.radius; this.y=Math.random()*canvas.height; }
    if(edge===2){ this.x=Math.random()*canvas.width; this.y=-this.radius; }
    if(edge===3){ this.x=Math.random()*canvas.width; this.y=canvas.height+this.radius; }
    this.color = type==="purple"?"purple":"red";
    this.speed = 0.5 + Math.random()*0.5;
    this.health = type==="purple"?2:1;
  }
  move(player){
    const dx = player.x - this.x;
    const dy = player.y - this.y;
    const d = Math.hypot(dx,dy);
    if(d>0){ this.x += dx/d*this.speed; this.y += dy/d*this.speed; }
  }
  draw(){
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fillStyle = this.color; ctx.fill();
  }
}

/* Particle */
class Particle {
  constructor(x,y,color,size=2){
    this.x=x; this.y=y; this.radius=size; this.color=color;
    this.dx=(Math.random()-0.5)*6; this.dy=(Math.random()-0.5)*6; this.life=30;
  }
  update(){ this.x+=this.dx; this.y+=this.dy; this.life--; }
  draw(){
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fillStyle=this.color; ctx.fill();
  }
}

/* Drops (pickup items) */
class Drop {
  constructor(x,y,type){
    this.x=x; this.y=y; this.radius=15; this.type=type; this.life=600;
  }
  draw(){
    ctx.font="20px Arial";
    ctx.textAlign="center";
    if(this.type==="bomb") ctx.fillText("üí£",this.x,this.y);
    if(this.type==="shield") ctx.fillText("üõ°Ô∏è",this.x,this.y);
    if(this.type==="blackhole") ctx.fillText("üåÄ",this.x,this.y);
  }
}

/* Black Hole object when used */
class BlackHole {
  constructor(x,y){
    this.x=x; this.y=y; this.radius=20; this.life=300;
  }
  update(){
    this.life--;
    this.radius = 20 + Math.sin(Date.now()/100)*5;
  }
  draw(){
    ctx.beginPath();
    const gradient = ctx.createRadialGradient(this.x,this.y,0,this.x,this.y,this.radius);
    gradient.addColorStop(0,"black");
    gradient.addColorStop(1,"purple");
    ctx.fillStyle = gradient;
    ctx.arc(this.x,this.y,this.radius,0,Math.PI*2);
    ctx.fill();
  }
}

/* ------------------------
   GAME STATE
   ------------------------ */
let player, bullets, enemies, particles, drops, blackHoles;
let score=0;
let money=0;
const ITEM_PRICE = 50;
let shootCooldown=0;
let shootInterval = 10;            // base shoot cooldown (frames)
const DEFAULT_SHOOT_INTERVAL = 10; // to restore after Rapid Fire
let shooting=true; // auto-shoot
let gameOver=false;
let paused=false;
let enemySpawnCounter=0;

/* Rapid Fire state */
let rapidActive = false;
let rapidTimeoutId = null;
const RAPID_DURATION_MS = 10000; // 10 seconds

/* Magnet state */
let magnetActive = false;
let magnetTimeoutId = null;
const MAGNET_DURATION_MS = 12000; // 12 seconds
const MAGNET_PULL_SPEED = 4; // how fast drops move toward player while magnet active

/* Inventory counts (multiples) */
const inventory = {
  bomb: 0,
  shield: 0,
  blackhole: 0,
  rapid: 0,   // shop-only ability
  magnet: 0   // shop-only ability
};

/* Toast pickups (floating text) */
function showPickupToast(text, x, y){
  const el = document.createElement("div");
  el.className = "pickupToast";
  el.textContent = text;
  document.body.appendChild(el);
  el.style.left = (x + canvas.getBoundingClientRect().left - 20) + "px";
  el.style.top = (y + canvas.getBoundingClientRect().top - 40) + "px";
  let life = 0;
  const id = setInterval(()=>{
    life++;
    el.style.top = (parseFloat(el.style.top) - 1) + "px";
    el.style.opacity = String(1 - life/40);
    if(life>40){ clearInterval(id); el.remove(); }
  },16);
}

/* ------------------------
   INPUT / PAUSE / INVENTORY UI
   ------------------------ */
window.addEventListener("keydown", e=>{
  const key = e.key.toLowerCase();

  // open shop with S (user requested)
  if(key === "s"){
    if(!isShopOpen()) openShop();
  }

  // close overlay with C
  if(key === "c"){
    if(isShopOpen()) closeShop();
    else if(isInventoryOpen()) closeInventory();
  }

  // also allow I to open inventory quickly
  if(key === "i"){
    if(!isInventoryOpen()) openInventory();
  }

  // pause with P (disabled when inventory/shop open)
  if(key === "p"){
    if(!isInventoryOpen() && !isShopOpen()){
      paused = !paused;
      pausedText.style.display = paused ? "block" : "none";
    }
  }

  // resume with R
  if(key === "r" && paused){
    paused=false;
    pausedText.style.display="none";
  }
});

const openInvBtn = document.getElementById("openInvBtn");
const inventoryOverlay = document.getElementById("inventoryOverlay");
const closeInvBtn = document.getElementById("closeInv");
const useBombBtn = document.getElementById("useBomb");
const useShieldBtn = document.getElementById("useShield");
const useBHBtn = document.getElementById("useBH");
const useRapidBtn = document.getElementById("useRapid");
const useMagnetBtn = document.getElementById("useMagnet");
const invBombText = document.getElementById("invBombText");
const invShieldText = document.getElementById("invShieldText");
const invBHText = document.getElementById("invBHText");
const invRapidText = document.getElementById("invRapidText");
const invMagnetText = document.getElementById("invMagnetText");
const pauseBtn = document.getElementById("pauseBtn");
const openShopBtn = document.getElementById("openShopBtn");
const shopOverlay = document.getElementById("shopOverlay");
const closeShopBtn = document.getElementById("closeShop");
const buyBombBtn = document.getElementById("buyBomb");
const buyShieldBtn = document.getElementById("buyShield");
const buyBHBtn = document.getElementById("buyBH");
const sellBombBtn = document.getElementById("sellBomb");
const sellShieldBtn = document.getElementById("sellShield");
const sellBHBtn = document.getElementById("sellBH");
const shopBombCount = document.getElementById("shopBombCount");
const shopShieldCount = document.getElementById("shopShieldCount");
const shopBHCount = document.getElementById("shopBHCount");

const buyRapidBtn = document.getElementById("buyRapid");
const sellRapidBtn = document.getElementById("sellRapid");
const shopRapidCount = document.getElementById("shopRapidCount");

const buyMagnetBtn = document.getElementById("buyMagnet");
const sellMagnetBtn = document.getElementById("sellMagnet");
const shopMagnetCount = document.getElementById("shopMagnetCount");

const openInvFromShopBtn = document.getElementById("openInvFromShop");
const openShopFromInvBtn = document.getElementById("openShopFromInv");

function isInventoryOpen(){ return inventoryOverlay.style.display === "flex"; }
function isShopOpen(){ return shopOverlay.style.display === "flex"; }

openInvBtn.addEventListener("click", ()=>{
  openInventory();
});
closeInvBtn.addEventListener("click", ()=>{
  closeInventory();
});

openInvFromShopBtn.addEventListener("click", ()=>{
  // go from shop to inventory
  closeShop();
  openInventory();
});

openShopFromInvBtn.addEventListener("click", ()=>{
  // go from inventory to shop
  closeInventory();
  openShop();
});

pauseBtn.addEventListener("click", ()=>{
  if(!isInventoryOpen() && !isShopOpen()){
    paused = !paused;
    pausedText.style.display = paused ? "block" : "none";
  }
});

/* Inventory open/close */
function openInventory(){
  paused = true;
  pausedText.style.display = "none"; // hide paused text; inventory shows instead
  inventoryOverlay.style.display = "flex";
  inventoryOverlay.style.alignItems = "center";
  inventoryOverlay.style.justifyContent = "center";
  updateInventoryUI();
}
function closeInventory(){
  inventoryOverlay.style.display = "none";
  paused = false;
}

/* Update inventory UI counts and buttons state */
function updateInventoryUI(){
  invBombText.textContent = inventory.bomb + "√ó";
  invShieldText.textContent = inventory.shield + "√ó";
  invBHText.textContent = inventory.blackhole + "√ó";
  invRapidText.textContent = inventory.rapid + "√ó";
  invMagnetText.textContent = inventory.magnet + "√ó";
  useBombBtn.disabled = inventory.bomb <= 0;
  useShieldBtn.disabled = inventory.shield <= 0;
  useBHBtn.disabled = inventory.blackhole <= 0;
  useRapidBtn.disabled = inventory.rapid <= 0;
  useMagnetBtn.disabled = inventory.magnet <= 0;

  // also update shop counts
  shopBombCount.textContent = inventory.bomb + "√ó";
  shopShieldCount.textContent = inventory.shield + "√ó";
  shopBHCount.textContent = inventory.blackhole + "√ó";
  shopRapidCount.textContent = inventory.rapid + "√ó";
  shopMagnetCount.textContent = inventory.magnet + "√ó";

  updateShopButtons();
}

/* Use actions (when clicking Use)
   CHANGED: using an item DOES NOT close inventory or resume the game.
   Inventory remains open and paused. Player must press Close (C) to resume.
*/
useBombBtn.addEventListener("click", ()=>{
  if(inventory.bomb>0){
    inventory.bomb--;
    updateInventoryUI();
    // keep inventory open and paused ‚Äî user must press Close (C)
    paused = true;
    useBombAt(player.x, player.y, 220); // bomb centered at player
  }
});
useShieldBtn.addEventListener("click", ()=>{
  if(inventory.shield>0){
    inventory.shield--;
    updateInventoryUI();
    paused = true;
    useShield();
  }
});
useBHBtn.addEventListener("click", ()=>{
  if(inventory.blackhole>0){
    inventory.blackhole--;
    updateInventoryUI();
    paused = true;
    useBlackHoleAt(player.x, player.y);
  }
});
useRapidBtn.addEventListener("click", ()=>{
  if(inventory.rapid>0){
    inventory.rapid--;
    updateInventoryUI();
    paused = true;
    activateRapidFire();
  }
});
useMagnetBtn.addEventListener("click", ()=>{
  if(inventory.magnet>0){
    inventory.magnet--;
    updateInventoryUI();
    paused = true;
    activateMagnet();
  }
});

/* ------------------------
   SHOP LOGIC
   ------------------------ */
openShopBtn.addEventListener("click", ()=> openShop());
closeShopBtn.addEventListener("click", ()=> closeShop());

function openShop(){
  paused = true;
  pausedText.style.display = "none";
  shopOverlay.style.display = "flex";
  shopOverlay.style.alignItems = "center";
  shopOverlay.style.justifyContent = "center";
  updateInventoryUI();
  updateMoneyUI();
}

function closeShop(){
  shopOverlay.style.display = "none";
  paused = false;
}

function updateMoneyUI(){
  moneyDisplay.textContent = "Money: $" + money;
}

function updateShopButtons(){
  // enable/disable buy if not enough money
  buyBombBtn.disabled = (money < ITEM_PRICE);
  buyShieldBtn.disabled = (money < ITEM_PRICE);
  buyBHBtn.disabled = (money < ITEM_PRICE);
  buyRapidBtn.disabled = (money < ITEM_PRICE);
  buyMagnetBtn.disabled = (money < ITEM_PRICE);

  // enable/disable sell if no items to sell
  sellBombBtn.disabled = (inventory.bomb <= 0);
  sellShieldBtn.disabled = (inventory.shield <= 0);
  sellBHBtn.disabled = (inventory.blackhole <= 0);
  sellRapidBtn.disabled = (inventory.rapid <= 0);
  sellMagnetBtn.disabled = (inventory.magnet <= 0);
}

/* Buy handlers */
buyBombBtn.addEventListener("click", ()=>{
  if(money >= ITEM_PRICE){
    money -= ITEM_PRICE;
    inventory.bomb++;
    updateMoneyUI();
    updateInventoryUI();
  }
});
buyShieldBtn.addEventListener("click", ()=>{
  if(money >= ITEM_PRICE){
    money -= ITEM_PRICE;
    inventory.shield++;
    updateMoneyUI();
    updateInventoryUI();
  }
});
buyBHBtn.addEventListener("click", ()=>{
  if(money >= ITEM_PRICE){
    money -= ITEM_PRICE;
    inventory.blackhole++;
    updateMoneyUI();
    updateInventoryUI();
  }
});
buyRapidBtn.addEventListener("click", ()=>{
  if(money >= ITEM_PRICE){
    money -= ITEM_PRICE;
    inventory.rapid++;
    updateMoneyUI();
    updateInventoryUI();
  }
});
buyMagnetBtn.addEventListener("click", ()=>{
  if(money >= ITEM_PRICE){
    money -= ITEM_PRICE;
    inventory.magnet++;
    updateMoneyUI();
    updateInventoryUI();
  }
});

/* Sell handlers */
sellBombBtn.addEventListener("click", ()=>{
  if(inventory.bomb > 0){
    inventory.bomb--;
    money += ITEM_PRICE;
    updateMoneyUI();
    updateInventoryUI();
  }
});
sellShieldBtn.addEventListener("click", ()=>{
  if(inventory.shield > 0){
    inventory.shield--;
    money += ITEM_PRICE;
    updateMoneyUI();
    updateInventoryUI();
  }
});
sellBHBtn.addEventListener("click", ()=>{
  if(inventory.blackhole > 0){
    inventory.blackhole--;
    money += ITEM_PRICE;
    updateMoneyUI();
    updateInventoryUI();
  }
});
sellRapidBtn.addEventListener("click", ()=>{
  if(inventory.rapid > 0){
    inventory.rapid--;
    money += ITEM_PRICE;
    updateMoneyUI();
    updateInventoryUI();
  }
});
sellMagnetBtn.addEventListener("click", ()=>{
  if(inventory.magnet > 0){
    inventory.magnet--;
    money += ITEM_PRICE;
    updateMoneyUI();
    updateInventoryUI();
  }
});

/* ------------------------
   Abilities Implementations
   ------------------------ */

/* Bomb: remove enemies within radius, spawn particle FX and increase score */
function useBombAt(x, y, radius=200){
  let removed = 0;
  for(let i=enemies.length-1;i>=0;i--){
    const e = enemies[i];
    const d = Math.hypot(e.x - x, e.y - y);
    if(d < radius){
      removed++;
      for(let k=0;k<20;k++) particles.push(new Particle(e.x,e.y,"orange",Math.random()*4+2));
      enemies.splice(i,1);
    }
  }
  if(removed>0){
    score += removed;
    // earn some money for kills caused by the bomb (treat as red kills)
    money += removed * 5;
    popScore();
    updateMoneyUI();
  }
  // spawn some new enemies to keep game alive
  for(let k=0;k<Math.min(removed+3, 12); k++) spawnEnemy();
}

/* Shield: grant player shield for 10s */
function useShield(){
  player.shielded = true;
  setTimeout(()=>{ player.shielded = false; }, 10000);
}

/* Black Hole: spawn a black hole at a location that attracts enemies */
function useBlackHoleAt(x,y){
  blackHoles.push(new BlackHole(x,y));
}

/* Rapid Fire: increases shooting speed 3x for RAPID_DURATION_MS */
function activateRapidFire(){
  if(rapidActive){
    clearTimeout(rapidTimeoutId);
  } else {
    rapidActive = true;
    shootInterval = Math.max(1, Math.floor(DEFAULT_SHOOT_INTERVAL / 3));
  }
  rapidTimeoutId = setTimeout(()=> {
    rapidActive = false;
    shootInterval = DEFAULT_SHOOT_INTERVAL;
  }, RAPID_DURATION_MS);
}

/* Magnet: pulls drops toward player for MAGNET_DURATION_MS (no cooldown) */
function activateMagnet(){
  if(magnetActive){
    clearTimeout(magnetTimeoutId);
  } else {
    magnetActive = true;
  }
  magnetTimeoutId = setTimeout(()=>{
    magnetActive = false;
  }, MAGNET_DURATION_MS);
}

/* ------------------------
   GAME LOGIC
   ------------------------ */
window.addEventListener("resize", ()=>{
  // keep canvas size same but repositioning mouse may be affected - not changing canvas dims
});

function resetGame(){
  player = new Player();
  bullets = [];
  enemies = [];
  particles = [];
  drops = [];
  blackHoles = [];
  score = 0;
  money = 0;
  gameOver = false;
  inventory.bomb = 0;
  inventory.shield = 0;
  inventory.blackhole = 0;
  inventory.rapid = 0;
  inventory.magnet = 0;
  rapidActive = false;
  if(rapidTimeoutId) { clearTimeout(rapidTimeoutId); rapidTimeoutId = null; shootInterval = DEFAULT_SHOOT_INTERVAL; }
  magnetActive = false;
  if(magnetTimeoutId) { clearTimeout(magnetTimeoutId); magnetTimeoutId = null; }
  updateInventoryUI();
  updateMoneyUI();
  for(let i=0;i<5;i++) spawnEnemy();
}

function spawnEnemy(){
  const type = Math.random()<0.2?"purple":"red";
  enemies.push(new Enemy(type));
}

function popScore(){
  scoreDisplay.classList.add("pop");
  setTimeout(()=>scoreDisplay.classList.remove("pop"),200);
}

function endGame(){
  gameOver = true;
  setTimeout(()=>{
    alert("üíÄ Game Over! Score: "+score);
    resetGame();
  },100);
}

/* Main animation loop */
function animate(){
  requestAnimationFrame(animate);

  if(gameOver || paused) return;

  ctx.fillStyle="rgba(0,0,0,0.3)";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  player.move();
  player.draw();

  // Shooting automatically using shootInterval
  if(shooting && shootCooldown<=0){
    bullets.push(new Bullet(player.x,player.y,mouse.x,mouse.y));
    shootCooldown = shootInterval;
  }
  if(shootCooldown>0) shootCooldown--;

  for(let i=bullets.length-1;i>=0;i--){
    const b=bullets[i]; b.update(); b.draw();
    if(b.x<0||b.x>canvas.width||b.y<0||b.y>canvas.height) bullets.splice(i,1);
  }

  enemySpawnCounter++;
  if(enemySpawnCounter % 60 === 0){
    spawnEnemy();
    if(Math.random()<0.3) spawnEnemy();
  }

  // Black holes attract enemies
  for(let i=blackHoles.length-1;i>=0;i--){
    const bh = blackHoles[i];
    bh.update(); bh.draw();
    enemies.forEach(e=>{
      const dx = bh.x - e.x;
      const dy = bh.y - e.y;
      const d = Math.hypot(dx,dy);
      if(d>0 && d<400){
        e.x += dx/d * 2;
        e.y += dy/d * 2;
      }
      if(d<bh.radius){
        for(let k=0;k<20;k++) particles.push(new Particle(e.x,e.y,"purple",Math.random()*4+2));
        score++; popScore();
        // award money for black hole kills
        money += 5;
        updateMoneyUI();
        // remove this enemy (safe removal later)
        enemies.splice(enemies.indexOf(e),1);
      }
    });
    if(bh.life<=0) blackHoles.splice(i,1);
  }

  for(let i=enemies.length-1;i>=0;i--){
    const e=enemies[i]; e.move(player); e.draw();
    for(let j=bullets.length-1;j>=0;j--){
      const b=bullets[j];
      if(dist(e,b)<e.radius+b.radius){
        e.health--;
        bullets.splice(j,1);
        if(e.health<=0){
          for(let k=0;k<20;k++) particles.push(new Particle(b.x,b.y,e.color,Math.random()*4+2));
          score++; popScore();
          // award money for kill based on type
          if(e.type==="purple") money += 10;
          else money += 5;
          updateMoneyUI();
          // drops only from purple enemies
          if(e.type==="purple"){
            const roll = Math.random();
            if(roll<0.33) drops.push(new Drop(e.x,e.y,"bomb"));
            else if(roll<0.66) drops.push(new Drop(e.x,e.y,"shield"));
            else drops.push(new Drop(e.x,e.y,"blackhole"));
          }
          enemies.splice(i,1); spawnEnemy();
        }
        break;
      }
    }
    if(dist(e,player)<e.radius+player.radius && !player.shielded){
      endGame();
    }
  }

  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.update(); p.draw();
    if(p.life<=0) particles.splice(i,1);
  }

  // Drops: if magnetActive, pull drops toward player
  for(let i=drops.length-1;i>=0;i--){
    const d=drops[i];
    if(magnetActive){
      // pull toward player
      const dx = player.x - d.x;
      const dy = player.y - d.y;
      const distToPlayer = Math.hypot(dx,dy) || 1;
      // move toward player by MAGNET_PULL_SPEED scaled by closeness
      d.x += dx/distToPlayer * MAGNET_PULL_SPEED;
      d.y += dy/distToPlayer * MAGNET_PULL_SPEED;
    }
    d.draw();
    d.life--;
    if(dist(d,player)<player.radius+d.radius){
      // collect
      if(d.type==="bomb"){
        inventory.bomb++;
        showPickupToast("Bomb +1", d.x, d.y);
      }
      if(d.type==="shield"){
        inventory.shield++;
        showPickupToast("Shield +1", d.x, d.y);
      }
      if(d.type==="blackhole"){
        inventory.blackhole++;
        showPickupToast("Black Hole +1", d.x, d.y);
      }
      updateInventoryUI();
      drops.splice(i,1);
    } else if(d.life<=0) drops.splice(i,1);
  }

  // update HUD
  scoreDisplay.textContent = "Score: "+score;
  moneyDisplay.textContent = "Money: $"+money;
}

/* start */
resetGame();
animate();

</script>
</body>
</html>
